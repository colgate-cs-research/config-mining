# config-mining
Summer 2021 research

# Parsing
Scripts for computing confidence or performing other analysis on configurations require a custom JSON representation of the configuration.  This custom JSON representation can be generated by relying on Batfish's parsing capabilities or a custom parser (e.g., for Aruba configs). 

## Using Batfish
The first time you want to parsing configurations using Batfish, you need to run the following commands:
```bash
pip3 install --upgrade pybatfish
docker pull batfish/allinone
docker run --name batfish -v batfish-data:/data -p 8888:8888 -p 9997:9997 -p 9996:9996 -d batfish/allinone
```

If you need to restart the Batfish service, run the following commands:
```bash
docker stop batfish
docker rm batfish
docker run --name batfish -v batfish-data:/data -p 8888:8888 -p 9997:9997 -p 9996:9996 -d batfish/allinone
```

See https://batfish.readthedocs.io/en/latest/getting_started.html for more detailed information about Batfish.

After the Batfish service is running, you can parse configurations using the `parsing/batfish.py` script. This script requires a single command-line argument: the path to a directory containing a configuration snapshot (see https://batfish.readthedocs.io/en/latest/notebooks/interacting.html#Packaging-snapshot-data for the required directory structure).

## Config JSON structure
```json
{
    "acls" : {
        acl_name : {
            "name" : acl_name,
            "lines" : [
                {
                    "action" : "DENY" | "PERMIT",
                    "dstIps" : destination_network,
                    "srcIps" : source_network
                },
                ...
            ],
            "remarks" : [
                remark_string,
                ...
            ]
        },
        ...
    },
    "interfaces" : {
        interface_name : {
            "access_vlan" : vlan_number | null,
            "address" : interface_address | null,
            "allowed_vlans" : [
                vlan_number,
                ...
            ],
            "description" : description_string | null,
            "in_acl" : acl_name | null,
            "name" : interface_name,
            "out_acl" : acl_name | null,
            "switchport" : "access" | "trunk" | null
        }
        ...
    },
    "name" : device_name,
    "ospf" :  {
        ospf_instance_number : {
            "areas" : {
                area_number : {
                    "name": area_number,
                    "networks" : [
                        network_address,
                        ...
                    ],
                    "type" : "NONE" | "NSSA" | "STUB"
                },
                ...
            },
            "interfaces" : [
                interface_name,
                ...
            ],
            "name" : ospf_instance_number,
            "vrf" : "default" | vrf_name
        },
        ...
    },
    "vlans" : {
        vlan_number : {
            "name": name_string,
            "num" : vlan_number
        },
        ...
    }
}
```


# Computing confidence


## Intra-config references
`analyze_refs.py` traverses a single file or a directory of files and evaluates confidence of four association rules (defined in third slide of "2021-05-25.pdf" notes).

arguments: 
* path to a file or directory 
    * example file path: `/shared/configs/sample/configs_json/core1.json`
    * example directory path: `/shared/configs/sample/configs_json/`
* outfile or output directory to write to 
    * example outfile: `output/sample.json`
    * example output directory: `output/sample/`

example command for single file traversal (in this case the filename is "core1.json"):
```bash
python3 analyze_refs.py /shared/configs/sample/configs_json/core1.json output/sample.json
```
example command for directory traversal: 
```bash
python3 analyze_refs.py /shared/configs/sample/configs_json/ output/sample/
```

## Keywords
`extract_keywords.py` traverses a single file or a directory of files and extracts keywords relating to interfaces and ACLs. It takes the same command line arguments as `analyze_refs.py`.